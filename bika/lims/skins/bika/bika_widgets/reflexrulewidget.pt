<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    i18n:domain="plone">

<head><title></title></head>
<body>

<metal:view_macro define-macro="view"
    tal:define="kssClassesView context/@@kss_field_decorator_view;
                getKssClasses nocall:kssClassesView/getKssClassesInlineEditable;">
<span metal:define-macro="records-field-view"
    tal:define="
        kss_class python:getKssClasses(fieldName,
        templateId='records_widget', macro='records-field-view');"
    tal:attributes="
        class kss_class;
        id string:parent-fieldname-$fieldName">
    <tal:block metal:define-slot="inside"
        tal:repeat="idx python:range(field.getSize(here))"
        tal:define="outerJoin field/outerJoin;
                    innerJoin field/innerJoin;">
        <span
            tal:define="subfieldValues python:[field.getViewFor(here,idx,key,innerJoin) for key in field.getSubfields()];
                        dummy python:subfieldValues.sort()"
            tal:replace="structure python:innerJoin.join(subfieldValues)" /><span
            tal:replace="structure outerJoin"
            tal:condition="not: repeat/idx/end" />
    </tal:block>
</span>
</metal:view_macro>

<metal:define define-macro="edit">
<metal:use use-macro="here/widgets/field/macros/edit">
<tal:block metal:fill-slot="widget_body">
    <span tal:replace="structure context/@@authenticator/authenticator"/>

    <fieldset style="border:none;"
        class="ArchetypesRecordsWidget"
        tal:define="
            values python:field.getEditAccessor(here)();
            session_values python:here.session_restore_value(fieldName, values);
            cached_values python:request.get(fieldName,session_values);
            values python:cached_values or values;
            dummy python:values.sort();
            i18n_domain field/widget/i18n_domain|context/i18n_domain|string:plone">
    <div id="rules-setup-data" style="display:none;visibility:hidden;"
        tal:content="widget/getReflexRuleSetup">
    </div>
    <table
        tal:attributes="id string:${fieldName}_table"
        class="recordswidget nosort">

    <tr class="header">
        <tal:block repeat="key python:field.getSubfields()">
            <th tal:condition="python:
                field.testSubfieldCondition(key,here,portal,template)
                and (not hasattr(field, 'subfield_hidden')
                     or field.subfield_hidden.get(key, False) == False)">
                <span
                    tal:content="structure python:
                        here.translate(domain=i18n_domain,
                                       msgid=field.getSubfieldLabel(key), default=field.getSubfieldLabel(key))">
                    Label
                </span>
                <span class="fieldRequired">&nbsp;</span>
            </th>
        </tal:block>
        <th>
            <span tal:condition="widget/allowDelete" i18n:translate="" id="delete_this_entry"></span>
        </th>
    </tr>

    <tr
        tal:attributes="class string:records_row_${fieldName}"
        tal:repeat="idx python:range(field.getEditSize(here))">

        <td>
            <tal:block
                define="
                    value python:field.getSubfieldValue(values, idx, 'rulesset');">
                <!-- Analysis Service selection -->
                <select
                    tal:attributes="
                        name string:${fieldName}.analysisservice:records:ignore_empty;
                        id string:${fieldName}-analysisservice-${repeat/idx/index};
                        tabindex tabindex/next|nothing;"
                        i18n:domain="python:i18n_domain">
                    <option
                        value=""
                        i18n:translate=""/>
                    </select>
                <!-- Range definition -->
                <span i18n:translate="" class="reflex_rule_text">
                    Expected Values: From
                </span>
                <input
                    tal:attributes="
                        name string:${fieldName}.range0:records:ignore_empty;
                        id string:${fieldName}-range0-${repeat/idx/index};
                        tabindex tabindex/next|nothing;
                        value python:widget.getReflexRuleValue(idx,'range0');"
                        i18n:domain="python:i18n_domain">
                <span i18n:translate="" class="reflex_rule_text">
                    To:
                </span>
                <input
                    tal:attributes="
                        name string:${fieldName}.range1:records:ignore_empty;
                        id string:${fieldName}-range1-${repeat/idx/index};
                        tabindex tabindex/next|nothing;
                        value python:widget.getReflexRuleValue(idx,'range1');"
                        i18n:domain="python:i18n_domain">
            </tal:block>
        </td>
        <td>
            <!-- delete -->
            <img tal:condition="widget/allowDelete"
                class="rw_deletebtn"
                tal:attributes="
                    id string:delete-row-${repeat/idx/index};
                    src string:${portal/absolute_url}/++resource++bika.lims.images/delete.png"/>

            <!-- Hidden fields -->
            <input
                type="hidden"
                name=""
                value=""
                tal:attributes="
                    id string:${fieldName}-analysisservice-${repeat/idx/index};
                    name string:${fieldName}.analysisservice:records:ignore_empty;
                    value python:field.getSubfieldValue(values, idx, 'rulesset');"/>
        </td>

    </tr>
    </table>

    <input
        type="button"
        class="context"
        value="More"
        tal:condition="python: field.showMore(values)"
        tal:attributes="id string:${fieldName}_more;tabindex tabindex/next|nothing"
        i18n:attributes="value" />
    </fieldset>
</tal:block>
</metal:use>
</metal:define>

<div metal:define-macro="search">
  <div metal:use-macro="here/widgets/string/macros/edit">
  </div>
</div>

</body>
</html>
