<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      i18n:domain="bika">
<body>
<div metal:define-macro="portlet"
    tal:define="
        member python: context.portal_membership.getAuthenticatedMember();
        user_name python: member.getUserName();
        brains python: here.portal_catalog(portal_type='LabContact') if user_name=='admin'  else here.portal_catalog(portal_type='LabContact',
                                    getUsername=user_name);"
    tal:condition="python:len(brains)>0">
<!-- Defining the base variables -->
<tal:departments
    tal:define="portal context/portal_url/getPortalObject;
                plone_view context/@@plone;
                current_usr python:brains[0].getObject();
                deps current_usr/getSortedDepartments;
                cookie python:request.cookies.get(
                    'filter_by_department_info','');
                dep_cookie python: cookie if cookie and len(deps)>1
                    else deps[0].UID();">
    <dl class="portlet" id="portletfilter_by_department">
        <!-- The header of the porlet -->
        <dt class="portletHeader"
            i18n:translate="">Department</dt>

        <!-- Opening the form -->
        <form
            action="portletfilter_by_department"
            name="portletfilter_by_department"
            method="POST">
            <dd class="portletItem">
                <input type="checkbox"
                       name="admin_dep_filter_enabled"
                       id="admin_dep_filter_enabled"
                       tal:condition= "python: user_name=='admin'"/>
                       <label tal:condition= "python: user_name=='admin'">Disable department filtering <br><br></label>
                <!-- The selection list -->
                <select id="department_filter_portlet"
                        name="department_filter_portlet"
                        i18n:domain="python:i18n_domain"
                        tal:attributes="style python: 'width:100%' if len(deps)>1 else 'display:none'">
                    <!-- Filling the other options with the departments assigned
                    to the user -->
                    <tal:option repeat="dep deps">
                    <option
                        tal:content="python:dep.Title()"
                        tal:attributes="
                            value python:dep.UID();
                            selected python:'selected' if dep_cookie == dep.UID() else ''"
                        i18n:translate=""/>
                    </tal:option>
                </select>
                <!-- Only a label with the department if one department only -->
                <label
                    i18n:translate=""
                    tal:condition="python: len(deps)<2"
                    tal:content="python: deps[0].Title()"
                    >Department</label>
            </dd>
            <!-- The submit form button -->
            <dd class="portletFooter" style="display:none">
                <input type="submit" id="department_filter_submit" value="Filter">
            </dd>
        </form>
    </dl>
</tal:departments>
</div>
</body>
</html>
