<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      i18n:domain="bika">
<body>
<div metal:define-macro="portlet"
    tal:define="
        member python: context.portal_membership.getAuthenticatedMember();
        user_name python: member.getUserName();
        brains python: [] if user_name=='admin'  else here.portal_catalog(portal_type='LabContact',
                                    getUsername=user_name);"
    tal:condition="python:context.bika_setup.getAllowDepartmentFiltering() and (len(brains)>0 or user_name=='admin') ">
<!-- Defining the base variables -->
<tal:departments
    tal:define="portal context/portal_url/getPortalObject;
                plone_view context/@@plone;
                deps python: here.portal_catalog(portal_type='Department',sort_on='sortable_title', sort_order='ascending',
                                            inactive_state='active') if user_name=='admin'  else brains[0].getObject().getSortedDepartments();
                cookie python:request.cookies.get(
                    'filter_by_department_info','');
                dep_from_cookie python: cookie.split(',')[0] if cookie and len(deps)>1
                    else 'doesnt_exist';
                dep_from_cat python: deps[0].UID if user_name=='admin'
                        else deps[0].UID();
                dep_cookie python: dep_from_cat if dep_from_cookie=='doesnt_exist'
                    else dep_from_cookie;">
    <dl class="portlet" id="portletfilter_by_department">
        <!-- The header of the porlet -->
        <dt class="portletHeader"
            i18n:translate="">Department</dt>

        <!-- Opening the form -->
        <form
            action="portletfilter_by_department"
            name="portletfilter_by_department"
            method="POST">
            <dd class="portletItem">
                <input type="checkbox"
                       name="admin_dep_filter_enabled"
                       id="admin_dep_filter_enabled"
                       tal:condition= "python: user_name=='admin'"/>
                       <label tal:condition= "python: user_name=='admin'">Disable department filtering <br><br></label>
                <!-- The selection list -->
                <select id="department_filter_portlet"
                        name="department_filter_portlet"
                        i18n:domain="python:i18n_domain"
                        tal:attributes="style python: 'width:100%' if len(deps)>1 else 'display:none'">
                    <!-- Filling the other options with the departments assigned
                    to the user -->
                    <tal:option repeat="dep deps">
                    <option
                        tal:content="python: dep.Title if user_name=='admin' else dep.Title()"
                        tal:attributes="
                            value python: dep.UID if user_name=='admin' else dep.UID();
                            selected python: 'selected' if user_name=='admin' and dep_cookie == dep.UID else 'selected' if user_name!='admin' and dep_cookie == dep.UID() else ''"
                        i18n:translate=""/>
                    </tal:option>
                </select>
                <!-- Only a label with the department if one department only -->
                <label
                    i18n:translate=""
                    tal:condition="python: len(deps)<2"
                    tal:content="python: deps[0].Title if user_name=='admin' else deps[0].Title()"
                    >Department</label>
            </dd>
            <!-- The submit form button -->
            <dd class="portletFooter" style="display:none">
                <input type="submit" id="department_filter_submit" value="Filter">
            </dd>
        </form>
    </dl>
</tal:departments>
</div>
</body>
</html>
